name: Valkey Search Benchmark

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to benchmark"
        required: false
        default: "main"
        type: string
      num_runs:
        description: "Number of runs to benchmark"
        required: false
        default: "1"
        type: string
  push:
  schedule:
    - cron: "0 9 * * *"

# Prevent concurrent workflow runs to avoid conflicts and resource contention
# - group: All workflow runs share the same concurrency group
# - cancel-in-progress: false: Queue new runs instead of canceling existing ones
concurrency:
  group: valkey-search-arm
  cancel-in-progress: false

defaults:
  run:
    shell: "bash -Eeuo pipefail -x {0}"

permissions:
  id-token: write
  contents: read

jobs:
  valkey_search_benchmark:
    env:
      BRANCH: ${{ inputs.branch || 'main' }}
      NUM_RUN: ${{ inputs.num_runs || '5' }}
    runs-on: [self-hosted, valkey-search-arm]
    timeout-minutes: 7200
    steps:
      - name: Set up Python
        uses: kishaningithub/setup-python-amazon-linux@63dc7bd642c6a564d0a93dd4b1cbe3e448ce3621
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Checkout valkey_ram (for dataset-enabled valkey-benchmark)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: VoletiRam/valkey_ram
          ref: dataset-support
          fetch-depth: 0
          path: valkey_ram

      - name: Checkout valkey (for valkey-server)
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          repository: valkey-io/valkey
          ref: unstable
          path: valkey
          fetch-depth: 0
          persist-credentials: false
      
      - name: Checkout valkey-search
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          repository: valkey-io/valkey-search
          ref: main
          path: valkey-search
          fetch-depth: 0
          persist-credentials: false

      - name: Fetch config from fork (temporary - remove after PR merges)
        run: |
          mkdir -p valkey-search/.github/benchmark_configs
          curl -f -o valkey-search/.github/benchmark_configs/fts-benchmarks-arm.json \
            https://raw.githubusercontent.com/VoletiRam/valkey-search/main/.github/benchmark_configs/fts-benchmarks-arm.json
          echo "✓ Fetched config from fork"

      - name: Checkout valkey-perf-benchmark
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: VoletiRam/valkey-perf-benchmark
          ref: fts_perf_test_final
          path: valkey-perf-benchmark

      - name: Setup persistent datasets cache
        run: |
          # Create persistent dataset directory on runner
          DATASET_CACHE="/home/ec2-user/search-datasets-cache"
          mkdir -p "$DATASET_CACHE"
          
          # Copy any repo-committed datasets to cache (updates/adds files)
          if [[ -d "valkey-perf-benchmark/datasets" ]] && [[ "$(ls -A valkey-perf-benchmark/datasets 2>/dev/null)" ]]; then
            echo "Updating cache with repo-committed datasets..."
            cp -r valkey-perf-benchmark/datasets/* "$DATASET_CACHE/" || true
          fi
          
          # Replace datasets directory with symlink to cache
          rm -rf valkey-perf-benchmark/datasets
          ln -sf "$DATASET_CACHE" valkey-perf-benchmark/datasets
          
          echo "✓ Dataset directory linked to persistent cache: $DATASET_CACHE"
          ls -lh valkey-perf-benchmark/ | grep datasets

      - name: Install dependencies
        working-directory: valkey-perf-benchmark
        run: |
          sudo dnf groupinstall "Development Tools" -y
          sudo dnf install -y gcc gcc-c++ cmake \
              ninja-build \
              python3-devel \
              openssl-devel \
              systemd-devel \
              bzip2-devel \
              libffi-devel \
              perf 
          
          gcc --version
          g++ --version
          
          pip install -r requirements.txt

      - name: Build valkey_ram (for dataset-enabled valkey-benchmark)
        working-directory: valkey_ram
        run: |
          echo "Building valkey_ram for valkey-benchmark with dataset support..."
          make distclean || true
          make BUILD_TLS=yes -j$(nproc)
          if [[ -f "src/valkey-benchmark" ]]; then
            echo "✓ valkey-benchmark with dataset support built successfully"
            ./src/valkey-benchmark --version || echo "Version check completed"
            ls -lh src/valkey-benchmark
          else
            echo "✗ valkey-benchmark build failed"
            exit 1
          fi

      - name: Build valkey (for valkey-server)
        working-directory: valkey
        run: |
          echo "Building valkey-server..."
          make distclean || true
          make BUILD_TLS=yes -j$(nproc)
          if [[ -f "src/valkey-server" ]]; then
            echo "✓ valkey-server build successful"
            ./src/valkey-server --version
            ls -lh src/valkey-server
          else
            echo "✗ valkey-server build failed"
            exit 1
          fi

      - name: Build valkey-search module
        working-directory: valkey-search
        run: |
          echo "Building valkey-search module..."
          
          # Verify GCC 12 installation
          if [[ ! -f "/usr/local/bin/gcc" ]]; then
            echo "✗ ERROR: GCC 12 not found at /usr/local/bin/gcc"
            echo "Please complete the GCC 12 installation on the runner first:"
            echo "  cd /tmp && wget https://ftp.gnu.org/gnu/gcc/gcc-12.3.0/gcc-12.3.0.tar.gz"
            echo "  tar xzf gcc-12.3.0.tar.gz && cd gcc-12.3.0"
            echo "  ./contrib/download_prerequisites"
            echo "  ./configure --prefix=/usr/local --enable-languages=c,c++"
            echo "  make -j\$(nproc) && sudo make install"
            exit 1
          fi
          
          # Use GCC 12 installed at /usr/local
          export PATH=/usr/local/bin:$PATH
          export LD_LIBRARY_PATH=/usr/local/lib64:${LD_LIBRARY_PATH:-}
          export CC=/usr/local/bin/gcc
          export CXX=/usr/local/bin/g++
          
          echo "Using GCC 12:"
          gcc --version
          g++ --version
          which gcc
          which g++
          
          ./build.sh
          if [[ -f ".build-release/libsearch.so" ]]; then
            echo "✓ valkey-search module build successful"
            ls -lh .build-release/libsearch.so
          else
            echo "✗ valkey-search module build failed"
            exit 1
          fi

      - name: Run Search Benchmarks
        working-directory: valkey-perf-benchmark
        run: |
          echo "Running search benchmarks..."
          echo "Config file: ../valkey-search/.github/benchmark_configs/fts-benchmarks-arm.json"
          echo "Config controls CPU pinning (server_cpu_range, client_cpu_range)"
          
          python benchmark.py \
            --module search \
            --valkey-path ../valkey \
            --valkey-benchmark-path ../valkey_ram/src/valkey-benchmark \
            --target-ip ${{ secrets.EC2_SEARCH_IP }} \
            --config ../valkey-search/.github/benchmark_configs/fts-benchmarks-arm.json \
            --mode both \
            --module-path ../valkey-search/.build-release/libsearch.so \
            --results-dir results \
            --runs $NUM_RUN

      - name: Clean large profiling data
        if: always()
        continue-on-error: true
        run: |
          echo "Removing large .perf.data files..."
          find valkey-perf-benchmark/results -name "*.perf.data" -type f -delete
          echo "✓ Removed raw perf data, keeping flamegraphs and reports"

      - name: Upload Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: valkey-perf-benchmark/results

      - name: Cleanup
        if: always()
        continue-on-error: true
        run: |
          echo "Cleaning up workspace..."
          pkill -f valkey || echo "No valkey processes found to kill"
          
          # No need to copy datasets - they're already in persistent cache via symlink
          echo "Datasets persist at /home/ec2-user/search-datasets-cache"
          
          # Clean workspace
          rm -rf valkey_ram valkey valkey-search valkey-perf-benchmark
