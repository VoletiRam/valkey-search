name: Redis vs Valkey Search Comparison

on:
  workflow_dispatch:
    inputs:
      valkey_branch:
        description: "Valkey branch to test"
        required: false
        default: "unstable"
        type: string
      valkey_search_branch:
        description: "Valkey-search branch to test"
        required: false
        default: "main"
        type: string
  push:
  schedule:
    - cron: "0 9 * * *"

# Prevent concurrent workflow runs
concurrency:
  group: redis-valkey-comparison-arm
  cancel-in-progress: false

defaults:
  run:
    shell: "bash -Eeuo pipefail -x {0}"

permissions:
  id-token: write
  contents: read

jobs:
  redis_valkey_comparison:
    env:
      VALKEY_BRANCH: ${{ inputs.valkey_branch || 'unstable' }}
      VALKEY_SEARCH_BRANCH: ${{ inputs.valkey_search_branch || 'main' }}
    runs-on: [self-hosted, redis-valkey-comparison-arm]
    timeout-minutes: 7200
    steps:
      - name: Set up Python
        uses: kishaningithub/setup-python-amazon-linux@63dc7bd642c6a564d0a93dd4b1cbe3e448ce3621
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Checkout valkey_ram (for dataset-enabled valkey-benchmark)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: VoletiRam/valkey_ram
          ref: dataset-support
          fetch-depth: 0
          path: valkey_ram

      - name: Checkout valkey (for valkey-server)
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          repository: valkey-io/valkey
          ref: ${{ env.VALKEY_BRANCH }}
          path: valkey
          fetch-depth: 0
          persist-credentials: false
      
      - name: Checkout valkey-search
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          repository: valkey-io/valkey-search
          ref: ${{ env.VALKEY_SEARCH_BRANCH }}
          path: valkey-search
          fetch-depth: 0
          persist-credentials: false

      - name: Checkout valkey-perf-benchmark
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: VoletiRam/valkey-perf-benchmark
          ref: fts_perf_test_final
          path: valkey-perf-benchmark

      - name: Setup persistent datasets cache
        run: |
          # Create persistent dataset directory on runner
          DATASET_CACHE="/home/ec2-user/search-datasets-cache"
          mkdir -p "$DATASET_CACHE"
          
          # Copy any repo-committed datasets to cache (updates/adds files)
          if [[ -d "valkey-perf-benchmark/datasets" ]] && [[ "$(ls -A valkey-perf-benchmark/datasets 2>/dev/null)" ]]; then
            echo "Updating cache with repo-committed datasets..."
            cp -r valkey-perf-benchmark/datasets/* "$DATASET_CACHE/" || true
          fi
          
          # Replace datasets directory with symlink to cache
          rm -rf valkey-perf-benchmark/datasets
          ln -sf "$DATASET_CACHE" valkey-perf-benchmark/datasets
          
          echo "✓ Dataset directory linked to persistent cache: $DATASET_CACHE"
          ls -lh valkey-perf-benchmark/ | grep datasets

      - name: Install dependencies
        working-directory: valkey-perf-benchmark
        run: |
          sudo dnf groupinstall "Development Tools" -y
          sudo dnf install -y gcc gcc-c++ cmake \
              ninja-build \
              python3-devel \
              openssl-devel \
              systemd-devel \
              bzip2-devel \
              libffi-devel \
              perf 
          
          gcc --version
          g++ --version
          
          pip install -r requirements.txt

      - name: Build valkey_ram (for dataset-enabled valkey-benchmark)
        working-directory: valkey_ram
        run: |
          echo "Building valkey_ram for valkey-benchmark with dataset support..."
          make distclean || true
          make BUILD_TLS=yes -j$(nproc)
          if [[ -f "src/valkey-benchmark" ]]; then
            echo "✓ valkey-benchmark with dataset support built successfully"
            ./src/valkey-benchmark --version || echo "Version check completed"
            ls -lh src/valkey-benchmark
          else
            echo "✗ valkey-benchmark build failed"
            exit 1
          fi

      - name: Build valkey (for valkey-server)
        working-directory: valkey
        run: |
          echo "Building valkey-server..."
          make distclean || true
          make BUILD_TLS=yes -j$(nproc)
          if [[ -f "src/valkey-server" ]]; then
            echo "✓ valkey-server build successful"
            ./src/valkey-server --version
            ls -lh src/valkey-server
          else
            echo "✗ valkey-server build failed"
            exit 1
          fi

      - name: Build valkey-search module
        working-directory: valkey-search
        run: |
          echo "Building valkey-search module..."
          
          # Verify GCC 12 installation
          if [[ ! -f "/usr/local/bin/gcc" ]]; then
            echo "✗ ERROR: GCC 12 not found at /usr/local/bin/gcc"
            echo "Please complete the GCC 12 installation on the runner first"
            exit 1
          fi
          
          # Use GCC 12 installed at /usr/local
          export PATH=/usr/local/bin:$PATH
          export LD_LIBRARY_PATH=/usr/local/lib64:${LD_LIBRARY_PATH:-}
          export CC=/usr/local/bin/gcc
          export CXX=/usr/local/bin/g++
          
          echo "Using GCC 12:"
          gcc --version
          g++ --version
          
          ./build.sh
          if [[ -f ".build-release/libsearch.so" ]]; then
            echo "✓ valkey-search module build successful"
            ls -lh .build-release/libsearch.so
          else
            echo "✗ valkey-search module build failed"
            exit 1
          fi

      - name: Run Valkey Benchmark (with config variations)
        working-directory: valkey-perf-benchmark
        run: |
          echo "Running Valkey benchmarks with config_sets variations..."
          echo "Config file: configs/fts-benchmarks.json"
          
          # Launch Valkey in Docker
          /home/ec2-user/redis-comparison-scripts/run_server_docker.sh \
            --server-type valkey \
            --port 6379 \
            --valkey-path $(pwd)/../valkey \
            --search-module $(pwd)/../valkey-search/.build-release/libsearch.so
          
          # Run benchmark
          python benchmark.py \
            --module search \
            --valkey-path ../valkey \
            --valkey-benchmark-path ../valkey_ram/src/valkey-benchmark \
            --target-ip ${{ secrets.EC2_SEARCH_REDIS_VALKEY_IP }} \
            --config configs/fts-benchmarks.json \
            --mode client \
            --use-running-server \
            --skip-profiling \
            --results-dir results/valkey
          
          # Stop Valkey
          /home/ec2-user/redis-comparison-scripts/stop_server_docker.sh --server-type valkey

      - name: Run Redis Benchmark (with skip-config-set)
        working-directory: valkey-perf-benchmark
        run: |
          echo "Running Redis benchmarks..."
          echo "Note: CONFIG SET commands will be skipped (Redis incompatible)"
          
          # Launch Redis container using script from persistent location
          /home/ec2-user/redis-comparison-scripts/run_server_docker.sh \
            --server-type redis \
            --port 6379
          
          # Run benchmark
          python benchmark.py \
            --module search \
            --valkey-path ../valkey \
            --valkey-benchmark-path ../valkey_ram/src/valkey-benchmark \
            --target-ip ${{ secrets.EC2_SEARCH_REDIS_VALKEY_IP }} \
            --config configs/fts-benchmarks.json \
            --mode client \
            --use-running-server \
            --skip-config-set \
            --skip-profiling \
            --results-dir results/redis
          
          # Stop Redis container
          /home/ec2-user/redis-comparison-scripts/stop_server_docker.sh --server-type redis

      - name: Generate Comparison Report
        working-directory: valkey-perf-benchmark
        if: always()
        run: |
          echo "Generating Redis vs Valkey comparison report..."
          
          python /home/ec2-user/redis-comparison-scripts/generate_redis_valkey_comparison.py \
            --valkey-results results/valkey/search_tests/metrics.json \
            --redis-results results/redis/search_tests/metrics.json \
            --output results/redis_valkey_comparison.csv

      - name: Upload Comparison Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: redis-valkey-comparison-results
          path: valkey-perf-benchmark/results/

      - name: Cleanup
        if: always()
        continue-on-error: true
        run: |
          echo "Cleaning up workspace..."
          pkill -f valkey || echo "No valkey processes found"
          
          # Stop any running Docker containers
          docker stop valkey-comparison redis-comparison 2>/dev/null || true
          docker rm valkey-comparison redis-comparison 2>/dev/null || true
          
          # Datasets persist at /home/ec2-user/search-datasets-cache
          echo "Datasets persist at /home/ec2-user/search-datasets-cache"
          
          # Clean workspace
          rm -rf valkey_ram valkey valkey-search valkey-perf-benchmark
